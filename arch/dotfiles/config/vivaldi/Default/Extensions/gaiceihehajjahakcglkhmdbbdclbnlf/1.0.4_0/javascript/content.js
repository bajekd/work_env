var reg=/^[\r\t\f\v ]+|[\r\t\f\v ]+$/gm,regEndsWithFlags=/\/(?!.*(.).*\1)[gimsuy]*$/,tc={settings:{lastSpeed:1,enabled:!0,speeds:{},displayKeyCode:86,rememberSpeed:!1,forceLastSavedSpeed:!1,audioBoolean:!1,startHidden:!1,controllerOpacity:.3,keyBindings:[],blacklist:"      www.instagram.com\n      twitter.com\n      vine.co\n      imgur.com\n      teams.microsoft.com\n    ".replace(reg,""),defaultLogLevel:4,logLevel:3},mediaElements:[]};function log(e,t){verbosity=tc.settings.logLevel,void 0===t&&(t=tc.settings.defaultLogLevel),verbosity}function getKeyBindings(e,t="value"){try{return tc.settings.keyBindings.find((t=>t.action===e))[t]}catch(e){return!1}}function setKeyBindings(e,t){tc.settings.keyBindings.find((t=>t.action===e)).value=t}function defineVideoController(){tc.videoController=function(e,t){if(e.vsc)return e.vsc;tc.mediaElements.push(e),this.video=e,this.parent=e.parentElement||t,storedSpeed=tc.settings.speeds[e.currentSrc],tc.settings.rememberSpeed?(log("Recalling stored speed due to rememberSpeed being enabled",5),storedSpeed=tc.settings.lastSpeed):(storedSpeed||(log("Overwriting stored speed to 1.0 due to rememberSpeed being disabled",5),storedSpeed=1),setKeyBindings("reset",getKeyBindings("fast"))),log("Explicitly setting playbackRate to: "+storedSpeed,5),e.playbackRate=storedSpeed,this.div=this.initializeControls();var n=function(e){storedSpeed=tc.settings.speeds[e.target.currentSrc],tc.settings.rememberSpeed?(log("Storing lastSpeed into tc.settings.speeds (rememberSpeed enabled)",5),storedSpeed=tc.settings.lastSpeed):(storedSpeed||(log("Overwriting stored speed to 1.0 (rememberSpeed not enabled)",4),storedSpeed=1),log("Setting reset keybinding to fast",5),setKeyBindings("reset",getKeyBindings("fast"))),log("Explicitly setting playbackRate to: "+storedSpeed,4),setSpeed(e.target,storedSpeed)};e.addEventListener("play",this.handlePlay=n.bind(this)),e.addEventListener("seeked",this.handleSeek=n.bind(this)),new MutationObserver((e=>{e.forEach((e=>{if("attributes"===e.type&&("src"===e.attributeName||"currentSrc"===e.attributeName)){log("mutation of A/V element",5);var t=this.div;e.target.src||e.target.currentSrc?t.classList.remove("vsc-nosource"):t.classList.add("vsc-nosource")}}))})).observe(e,{attributeFilter:["src","currentSrc"]})},tc.videoController.prototype.remove=function(){this.div.remove(),this.video.removeEventListener("play",this.handlePlay),this.video.removeEventListener("seek",this.handleSeek),delete this.video.vsc;let e=tc.mediaElements.indexOf(this.video);-1!=e&&tc.mediaElements.splice(e,1)},tc.videoController.prototype.initializeControls=function(){log("initializeControls Begin",5);let e=this.video.ownerDocument,t=this.video.playbackRate.toFixed(2),n=this.video.getBoundingClientRect(),i=this.video.offsetParent?.getBoundingClientRect(),o=Math.max(n.top-(i?.top||0),0)+"px",s=Math.max(n.left-(i?.left||0),0)+"px";log("Speed variable set to: "+t,5);var a=e.createElement("div");a.classList.add("vsc-controller"),this.video.currentSrc||a.classList.add("vsc-nosource"),tc.settings.startHidden&&a.classList.add("vsc-hidden");var r=a.attachShadow({mode:"open"}),d=`\n        <style>\n          @import "${chrome.runtime.getURL("css/shade.css")}";\n        </style>\n\n        <div id="controller" style="top:${o}; left:${s}; opacity:${tc.settings.controllerOpacity}">\n          <span data-action="drag" class="draggable">${t}</span>\n          <span id="controls">\n            <button data-action="rewind" class="rw">«</button>\n            <button data-action="slower">&minus;</button>\n            <button data-action="faster">&plus;</button>\n            <button data-action="advance" class="rw">»</button>\n            <button data-action="display" class="hideButton">&times;</button>\n          </span>\n        </div>\n      `;r.innerHTML=d,r.querySelector(".draggable").addEventListener("mousedown",(e=>{runAction(e.target.dataset.action,!1,e),e.stopPropagation()}),!0),r.querySelectorAll("button").forEach((function(e){e.addEventListener("click",(e=>{runAction(e.target.dataset.action,getKeyBindings(e.target.dataset.action),e),e.stopPropagation()}),!0)})),r.querySelector("#controller").addEventListener("click",(e=>e.stopPropagation()),!1),r.querySelector("#controller").addEventListener("mousedown",(e=>e.stopPropagation()),!1),this.speedIndicator=r.querySelector("span");var l=e.createDocumentFragment();switch(l.appendChild(a),!0){case"www.amazon.com"==location.hostname:case"www.reddit.com"==location.hostname:case/hbogo\./.test(location.hostname):this.parent.parentElement.insertBefore(l,this.parent);break;case"www.facebook.com"==location.hostname:let e=this.parent.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement;e.insertBefore(l,e.firstChild);break;case"tv.apple.com"==location.hostname:this.parent.parentNode.insertBefore(l,this.parent.parentNode.firstChild);break;default:this.parent.insertBefore(l,this.parent.firstChild)}return a}}function escapeStringRegExp(e){return matchOperatorsRe=/[|\\{}()[\]^$+*?.]/g,e.replace(matchOperatorsRe,"\\$&")}function isBlacklisted(){return blacklisted=!1,tc.settings.blacklist.split("\n").forEach((e=>{if(0!=(e=e.replace(reg,"")).length){if(e.startsWith("/"))try{var t=e.split("/");if(regEndsWithFlags.test(e))var n=t.pop(),i=t.slice(1).join("/");else n="",i=e;var o=RegExp(i,n)}catch(e){return}else o=RegExp(escapeStringRegExp(e));if(o.test(location.href))return void(blacklisted=!0)}})),blacklisted}chrome.storage.sync.get(tc.settings,(function(e){tc.settings.keyBindings=e.keyBindings,0==e.keyBindings.length&&(tc.settings.keyBindings.push({action:"slower",key:Number(e.slowerKeyCode)||83,value:Number(e.speedStep)||.1,force:!1,predefined:!0}),tc.settings.keyBindings.push({action:"faster",key:Number(e.fasterKeyCode)||68,value:Number(e.speedStep)||.1,force:!1,predefined:!0}),tc.settings.keyBindings.push({action:"rewind",key:Number(e.rewindKeyCode)||90,value:Number(e.rewindTime)||10,force:!1,predefined:!0}),tc.settings.keyBindings.push({action:"advance",key:Number(e.advanceKeyCode)||88,value:Number(e.advanceTime)||10,force:!1,predefined:!0}),tc.settings.keyBindings.push({action:"reset",key:Number(e.resetKeyCode)||82,value:1,force:!1,predefined:!0}),tc.settings.keyBindings.push({action:"fast",key:Number(e.fastKeyCode)||71,value:Number(e.fastSpeed)||1.8,force:!1,predefined:!0}),tc.settings.version="0.5.3",chrome.storage.sync.set({keyBindings:tc.settings.keyBindings,version:tc.settings.version,displayKeyCode:tc.settings.displayKeyCode,rememberSpeed:tc.settings.rememberSpeed,forceLastSavedSpeed:tc.settings.forceLastSavedSpeed,audioBoolean:tc.settings.audioBoolean,startHidden:tc.settings.startHidden,enabled:tc.settings.enabled,controllerOpacity:tc.settings.controllerOpacity,blacklist:tc.settings.blacklist.replace(reg,"")})),tc.settings.lastSpeed=Number(e.lastSpeed),tc.settings.displayKeyCode=Number(e.displayKeyCode),tc.settings.rememberSpeed=Boolean(e.rememberSpeed),tc.settings.forceLastSavedSpeed=Boolean(e.forceLastSavedSpeed),tc.settings.audioBoolean=Boolean(e.audioBoolean),tc.settings.enabled=Boolean(e.enabled),tc.settings.startHidden=Boolean(e.startHidden),tc.settings.controllerOpacity=Number(e.controllerOpacity),tc.settings.blacklist=String(e.blacklist),0==tc.settings.keyBindings.filter((e=>"display"==e.action)).length&&tc.settings.keyBindings.push({action:"display",key:Number(e.displayKeyCode)||86,value:0,force:!1,predefined:!0}),initializeWhenReady(document)}));var coolDown=!1;function refreshCoolDown(){log("Begin refreshCoolDown",5),coolDown&&clearTimeout(coolDown),coolDown=setTimeout((function(){coolDown=!1}),1e3),log("End refreshCoolDown",5)}function setupListener(){function e(e){if(e.vsc){var t=e.vsc.speedIndicator,n=e.currentSrc,i=Number(e.playbackRate.toFixed(2));log("Playback rate changed to "+i,4),log("Updating controller with new speed",5),t.textContent=i.toFixed(2),tc.settings.speeds[n]=i,log("Storing lastSpeed in settings for the rememberSpeed feature",5),tc.settings.lastSpeed=i,log("Syncing chrome settings for lastSpeed",5),chrome.storage.sync.set({lastSpeed:i},(function(){log("Speed setting saved: "+i,5)})),runAction("blink",null,null)}}document.addEventListener("ratechange",(function(t){coolDown&&(log("Speed event propagation blocked",4),t.stopImmediatePropagation());var n=t.target;tc.settings.forceLastSavedSpeed?(t.detail&&"videoSpeed"===t.detail.origin?(n.playbackRate=t.detail.speed,e(n)):n.playbackRate=tc.settings.lastSpeed,t.stopImmediatePropagation()):e(n)}),!0)}function initializeWhenReady(e){log("Begin initializeWhenReady",5),!isBlacklisted()&&(window.onload=()=>{initializeNow(window.document)},e&&("complete"===e.readyState?initializeNow(e):e.onreadystatechange=()=>{"complete"===e.readyState&&initializeNow(e)}),log("End initializeWhenReady",5))}function inIframe(){try{return window.self!==window.top}catch(e){return!0}}function getShadow(e){let t=[];return function e(n){if(n.firstElementChild){var i=n.firstElementChild;do{t.push(i),e(i),i.shadowRoot&&t.push(getShadow(i.shadowRoot)),i=i.nextElementSibling}while(i)}}(e),t.flat(1/0)}function initializeNow(e){if(log("Begin initializeNow",5),tc.settings.enabled){if(!e.body||e.body.classList.contains("vsc-initialized"))return;try{setupListener()}catch{}if(e.body.classList.add("vsc-initialized"),log("initializeNow: vsc-initialized added to document body",5),e===window.document)defineVideoController();else{var t=e.createElement("link");t.href=chrome.runtime.getURL("content.css"),t.type="text/css",t.rel="stylesheet",e.head.appendChild(t)}var n=Array(e);try{inIframe()&&n.push(window.top.document)}catch(e){}if(n.forEach((function(e){e.addEventListener("keydown",(function(e){var t=e.keyCode;if(log("Processing keydown event: "+t,6),!(!e.getModifierState||e.getModifierState("Alt")||e.getModifierState("Control")||e.getModifierState("Fn")||e.getModifierState("Meta")||e.getModifierState("Hyper")||e.getModifierState("OS"))){if("INPUT"===e.target.nodeName||"TEXTAREA"===e.target.nodeName||e.target.isContentEditable||!tc.mediaElements.length)return!1;var n=tc.settings.keyBindings.find((e=>e.key===t));return n&&(runAction(n.action,n.value),"true"===n.force&&(e.preventDefault(),e.stopPropagation())),!1}log("Keydown event ignored due to active modifier: "+t,5)}),!0)})),new MutationObserver((function(t){requestIdleCallback((n=>{t.forEach((function(t){switch(t.type){case"childList":t.addedNodes.forEach((function(n){if("function"!=typeof n){if(n===e.documentElement)return log("Document was replaced, reinitializing",5),void initializeWhenReady(e);s(n,n.parentNode||t.target,!0)}})),t.removedNodes.forEach((function(e){"function"!=typeof e&&s(e,e.parentNode||t.target,!1)}));break;case"attributes":if(t.target.attributes["aria-hidden"]&&"false"==t.target.attributes["aria-hidden"].value||"APPLE-TV-PLUS-PLAYER"===t.target.nodeName){var n=getShadow(e.body).filter((e=>"VIDEO"==e.tagName));for(let e of n)e.vsc&&"APPLE-TV-PLUS-PLAYER"===t.target.nodeName||(e.vsc&&e.vsc.remove(),s(e,e.parentNode||t.target,!0))}}}))}),{timeout:1e3})})).observe(e,{attributeFilter:["aria-hidden","data-focus-method"],childList:!0,subtree:!0}),tc.settings.audioBoolean)var i=e.querySelectorAll("video,audio");else i=e.querySelectorAll("video");i.forEach((function(e){e.vsc=new tc.videoController(e)}));var o=e.getElementsByTagName("iframe");Array.prototype.forEach.call(o,(function(e){try{var t=e.contentDocument}catch(e){return}initializeWhenReady(t)})),log("End initializeNow",5)}function s(t,n,i){if(i||!e.body.contains(t))if("VIDEO"===t.nodeName||"AUDIO"===t.nodeName&&tc.settings.audioBoolean)i?t.vsc=new tc.videoController(t,n):t.vsc&&t.vsc.remove();else if(null!=t.children)for(var o=0;o<t.children.length;o++){let e=t.children[o];s(e,e.parentNode||n,i)}}}function setSpeed(e,t){log("setSpeed started: "+t,5);var n=t.toFixed(2);tc.settings.forceLastSavedSpeed?e.dispatchEvent(new CustomEvent("ratechange",{detail:{origin:"videoSpeed",speed:n}})):e.playbackRate=Number(n),e.vsc.speedIndicator.textContent=n,tc.settings.lastSpeed=t,refreshCoolDown(),log("setSpeed finished: "+t,5)}function runAction(e,t,n){log("runAction Begin",5);var i=tc.mediaElements;if(n)var o=n.target.getRootNode().host;i.forEach((function(i){var s=i.vsc.div;if(!(n&&o!=s||(showController(s),i.classList.contains("vsc-cancelled"))))if("rewind"===e)log("Rewind",5),i.currentTime-=t;else if("advance"===e)log("Fast forward",5),i.currentTime+=t;else if("faster"===e){log("Increase speed",5),setSpeed(i,Math.min((i.playbackRate<.1?0:i.playbackRate)+t,16))}else if("slower"===e){log("Decrease speed",5),setSpeed(i,Math.max(i.playbackRate-t,.07))}else"reset"===e?(log("Reset speed",5),resetSpeed(i,1)):"display"===e?(log("Showing controller",5),s.classList.add("vsc-manual"),s.classList.toggle("vsc-hidden")):"blink"===e?(log("Showing controller momentarily",5),(s.classList.contains("vsc-hidden")||void 0!==s.blinkTimeOut)&&(clearTimeout(s.blinkTimeOut),s.classList.remove("vsc-hidden"),s.blinkTimeOut=setTimeout((()=>{s.classList.add("vsc-hidden"),s.blinkTimeOut=void 0}),t||1e3))):"drag"===e?handleDrag(i,n):"fast"===e?resetSpeed(i,t):"pause"===e?pause(i):"muted"===e?muted(i):"mark"===e?setMark(i):"jump"===e&&jumpToMark(i)})),log("runAction End",5)}function pause(e){e.paused?(log("Resuming video",5),e.play()):(log("Pausing video",5),e.pause())}function resetSpeed(e,t){e.playbackRate===t?e.playbackRate===getKeyBindings("reset")?1!==t?(log("Resetting playback speed to 1.0",4),setSpeed(e,1)):(log('Toggling playback speed to "fast" speed',4),setSpeed(e,getKeyBindings("fast"))):(log('Toggling playback speed to "reset" speed',4),setSpeed(e,getKeyBindings("reset"))):(log('Toggling playback speed to "reset" speed',4),setKeyBindings("reset",e.playbackRate),setSpeed(e,t))}function muted(e){e.muted=!0!==e.muted}function setMark(e){log("Adding marker",5),e.vsc.mark=e.currentTime}function jumpToMark(e){log("Recalling marker",5),e.vsc.mark&&"number"==typeof e.vsc.mark&&(e.currentTime=e.vsc.mark)}function handleDrag(e,t){let n=e.vsc.div,i=n.shadowRoot.querySelector("#controller");for(var o=n.parentElement;o.parentNode&&o.parentNode.offsetHeight===o.offsetHeight&&o.parentNode.offsetWidth===o.offsetWidth;)o=o.parentNode;e.classList.add("vcs-dragging"),i.classList.add("dragging");let s=[t.clientX,t.clientY],a=[parseInt(i.style.left),parseInt(i.style.top)],r=e=>{let t=i.style,n=e.clientX-s[0],o=e.clientY-s[1];t.left=a[0]+n+"px",t.top=a[1]+o+"px"},d=()=>{o.removeEventListener("mousemove",r),o.removeEventListener("mouseup",d),o.removeEventListener("mouseleave",d),i.classList.remove("dragging"),e.classList.remove("vcs-dragging")};o.addEventListener("mouseup",d),o.addEventListener("mouseleave",d),o.addEventListener("mousemove",r)}var timer=null;function showController(e){log("Showing controller",4),e.classList.add("vcs-show"),timer&&clearTimeout(timer),timer=setTimeout((function(){e.classList.remove("vcs-show"),timer=!1,log("Hiding controller",5)}),2e3)}